var map;
var locations = {
    ceremony: { lat: 48.43458386438713, lng: -123.47274328929615, zoom: 18 },
    reception: { lat: 48.420484750679705, lng: -123.3629612943166, zoom: 17 }
};

function initMap() {
    var centerPos = {
        lat: (locations.ceremony.lat + locations.reception.lat) / 2,
        lng: (locations.ceremony.lng + locations.reception.lng) / 2
    };

    map = new google.maps.Map(document.getElementById("map-canvas"), {
        zoom: 13,
        center: centerPos,
        scrollwheel: false
    });

    for (var key in locations) {
        new google.maps.Marker({
            position: { lat: locations[key].lat, lng: locations[key].lng },
            map: map,
            title: key === "ceremony" ? "Ceremony: Hatley Castle" : "Reception: Parkside Hotel"
        });
    }
}

function smoothZoom(map, targetZoom, step) {
    var currentZoom = map.getZoom();
    step = step || 0.5;
    if (currentZoom === targetZoom) return;

    var nextZoom = currentZoom + (currentZoom < targetZoom ? step : -step);
    map.setZoom(nextZoom);

    if ((step > 0 && nextZoom < targetZoom) || (step < 0 && nextZoom > targetZoom)) {
        setTimeout(function() { smoothZoom(map, targetZoom, step); }, 50);
    }
}

// Clickable titles with smooth pan + zoom
$(document).on("click", ".map-location", function(e) {
    e.preventDefault();
    var key = $(this).data('key');
    var loc = locations[key];

    map.panTo({ lat: loc.lat, lng: loc.lng });

    setTimeout(function() {
        if (map.getZoom() !== loc.zoom) {
            smoothZoom(map, loc.zoom, 1);
        }
    }, 300);
});

// Show map / Show info toggle
function toggleMapInfo(showMap) {
    if (showMap) {
        $('#map-content-wrapper').addClass('hidden');
        $('#btn-show-map').addClass('toggle-map-content');
        $('#btn-show-content').removeClass('toggle-map-content');
    } else {
        $('#map-content-wrapper').removeClass('hidden');
        $('#btn-show-map').removeClass('toggle-map-content');
        $('#btn-show-content').addClass('toggle-map-content');
    }
}

$(document).on("click", "#btn-show-map", function(e) {
    e.preventDefault();
    toggleMapInfo(true);
});

$(document).on("click", "#btn-show-content", function(e) {
    e.preventDefault();
    toggleMapInfo(false);
});

// Alert markup helper
function alert_markup(type, message) {
    return `<div class="alert alert-${type}" role="alert">${message}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span>&times;</span>
        </button>
    </div>`;
}




$(document).ready(function() {
    // Waypoints
    $(".wp1, .wp3, .wp5, .wp8").waypoint(function() { $(this.element).addClass("animated fadeInLeft"); }, { offset: "75%" });
    $(".wp2, .wp4, .wp6, .wp9").waypoint(function() { $(this.element).addClass("animated fadeInRight"); }, { offset: "75%" });
    $(".wp7").waypoint(function() { $(".wp7").addClass("animated fadeInUp"); }, { offset: "75%" });

    // Flexslider & Fancybox
    $(".flexslider").flexslider({ animation: "slide" });
    $(".single_image, .fancybox").fancybox({ padding: 4, width: 1000, height: 800 });

    // Tooltip initialization
    $('[data-toggle="tooltip"]').tooltip();

    // Nav toggle click & close links
    $(document).on("click", ".nav-toggle", function(e) {
        e.preventDefault();
        $(this).toggleClass("active");
        $(".header-nav").toggleClass("open");
    });
    $(document).on("click", ".header-nav li a", function() {
        $(".nav-toggle").removeClass("active");
        $(".header-nav").removeClass("open");
    });

    // Scroll adjustments
    $(window).scroll(function() {
        if ($(window).scrollTop() >= 20) {
            $("section.navigation").addClass("fixed");
            $("header").css({ "border-bottom": "none", padding: "35px 0" });
            $("header .member-actions").css({ top: "26px" });
            $("header .navicon").css({ top: "34px" });
        } else {
            $("section.navigation").removeClass("fixed");
            $("header").css({ "border-bottom": "solid 1px rgba(255, 255, 255, 0.2)", padding: "50px 0" });
            $("header .member-actions").css({ top: "41px" });
            $("header .navicon").css({ top: "48px" });
        }
    });

    // Smooth scroll for anchor links
    $("a[href*=#]:not([href=#])").click(function() {
        if (location.pathname.replace(/^\//, "") === this.pathname.replace(/^\//, "") &&
            location.hostname === this.hostname) {
            var target = $(this.hash);
            target = target.length ? target : $("[name=" + this.hash.slice(1) + "]");
            if (target.length) {
                $("html,body").animate({ scrollTop: target.offset().top - 90 }, 500);
                return false;
            }
        }
    });

    // YouTube Player
    $(".player").YTPlayer();

    // Google +1 script
    var shareBars = document.getElementsByClassName("share-bar");
    if (shareBars.length) {
        var script = document.createElement("script");
        script.type = "text/javascript";
        script.async = true;
        script.src = "https://apis.google.com/js/platform.js";
        document.getElementsByTagName("script")[0].parentNode.insertBefore(script, document.getElementsByTagName("script")[0]);
    }

    // Calendar
    var calendarHTML = createCalendar({
        options: { class: "", id: "" },
        data: {
            title: "Wedding - Edward and Sara",
            start: new Date("Oct 10, 2027 12:00"),
            end: new Date("Oct 10, 2027 23:00"),
            address: "2005 Sooke Rd, Victoria, BC V9B 5Y2",
            description: "We can't wait to see you on our big day. For any queries or issues, please contact Edward Dong at +1 587 709 9777."
        }
    });
    $("#add-to-cal").html(calendarHTML);

    // RSVP form submission
    $("#rsvp-form").on("submit", function(e) {
        e.preventDefault();
        var data = $(this).serialize();
        $("#alert-wrapper").html(alert_markup("info", "<strong>Just a sec!</strong> We are saving your details."));

        if (MD5($("#invite_code").val()) !== "b0e53b10c1f55ede516b240036b88f40" &&
            MD5($("#invite_code").val()) !== "2ac7f43695eb0479d5846bb38eec59cc") {
            $("#alert-wrapper").html(alert_markup("danger", "<strong>Sorry!</strong> Your invite code is incorrect."));
            return;
        }

        $.post("https://script.google.com/macros/s/AKfycbwNp_1etlfsP7dxVLT5XFa7z8RLUihTttOiLFxA1GNgyp5fMLR0c7eTrbI5M1ZhHLwS/exec", data)
            .done(function(response) {
                if (response.result === "error") {
                    $("#alert-wrapper").html(alert_markup("danger", response.message));
                } else {
                    $("#alert-wrapper").html("");
                    $("#rsvp-modal").modal("show");
                }
            })
            .fail(function() {
                $("#alert-wrapper").html(alert_markup("danger", "<strong>Sorry!</strong> There is some issue with the server."));
            });
    });
});


// MD5 function
var MD5 = function(e) {
    function l(e, t) { return e << t | e >>> 32 - t; }
    function c(e, t) { 
        var a, n, o, r, i;
        o = 2147483648 & e;
        r = 2147483648 & t;
        i = (1073741823 & e) + (1073741823 & t);
        (a = 1073741824 & e) & (n = 2147483648 & t) ? i = 2147483648 ^ i ^ o ^ r :
        a | n ? i = 1073741824 & i ? 3221225472 ^ i ^ o ^ r : 1073741824 ^ i ^ o ^ r :
        i = i ^ o ^ r;
        return i;
    }
    function t(e, t, a, n, o, r, i) { var s; e = c(e, c(c((s = t) & a | ~s & n, o), i)); return c(l(e, r), t); }
    function a(e, t, a, n, o, r, i) { var s; e = c(e, c(c(t & (s = n) | a & ~s, o), i)); return c(l(e, r), t); }
    function n(e, t, a, n, o, r, i) { return c(l(c(e, c(c(t ^ a ^ n, o), i)), r), t); }
    function o(e, t, a, n, o, r, i) { return c(l(c(e, c(c(a ^ (t | ~n), o), i)), r), t); }
    function r(e) { var t, a = "", n = ""; for (t = 0; t <= 3; t++) a += (n = "0" + (e >>> 8 * t & 255).toString(16)).substr(n.length - 2, 2); return a; }

    var i, s, p, d, m, f, g, h, u, w = Array();

    w = (function(e) {
        for (var t, a = e.length, n = a + 8, o = 16 * (1 + Math.floor(n / 64)), r = Array(o - 1), i = 0, s = 0; s < a;) {
            i = s % 4 * 8;
            r[t = Math.floor(s / 4)] = r[t] | e.charCodeAt(s) << i;
            s++;
        }
        i = s % 4 * 8;
        r[t = Math.floor(s / 4)] = r[t] | 128 << i;
        r[o - 2] = a << 3;
        r[o - 1] = a >>> 29;
        return r;
    })(function(e) {
        e = e.replace(/\r\n/g, "\n");
        var t = "";
        for (var a = 0; a < e.length; a++) {
            var n = e.charCodeAt(a);
            if (n < 128) t += String.fromCharCode(n);
            else if (n > 127 && n < 2048) t += String.fromCharCode(n >> 6 | 192), t += String.fromCharCode(63 & n | 128);
            else t += String.fromCharCode(n >> 12 | 224), t += String.fromCharCode(n >> 6 & 63 | 128), t += String.fromCharCode(63 & n | 128);
        }
        return t;
    })(e);

    f = 1732584193;
    g = 4023233417;
    h = 2562383102;
    u = 271733878;

    for (i = 0; i < w.length; i += 16) {
        f = t(f, g, h, u, w[i + 0], 7, 3614090360);
        u = t(u, f, g, h, w[i + 1], 12, 3905402710);
        h = t(h, u, f, g, w[i + 2], 17, 606105819);
        g = t(g, h, u, f, w[i + 3], 22, 3250441966);

        f = t(f, g, h, u, w[i + 4], 7, 4118548399);
        u = t(u, f, g, h, w[i + 5], 12, 1200080426);
        h = t(h, u, f, g, w[i + 6], 17, 2821735955);
        g = t(g, h, u, f, w[i + 7], 22, 4249261313);

        f = t(f, g, h, u, w[i + 8], 7, 1770035416);
        u = t(u, f, g, h, w[i + 9], 12, 2336552879);
        h = t(h, u, f, g, w[i + 10], 17, 4294925233);
        g = t(g, h, u, f, w[i + 11], 22, 2304563134);

        f = t(f, g, h, u, w[i + 12], 7, 1804603682);
        u = t(u, f, g, h, w[i + 13], 12, 4254626195);
        h = t(h, u, f, g, w[i + 14], 17, 2792965006);
        g = t(g, h, u, f, w[i + 15], 22, 1236535329);

        f = a(f, g, h, u, w[i + 1], 5, 4129170786);
        u = a(u, f, g, h, w[i + 6], 9, 3225465664);
        h = a(h, u, f, g, w[i + 11], 14, 643717713);
        g = a(g, h, u, f, w[i + 0], 20, 3921069994);

        f = a(f, g, h, u, w[i + 5], 5, 3593408605);
        u = a(u, f, g, h, w[i + 10], 9, 38016083);
        h = a(h, u, f, g, w[i + 15], 14, 3634488961);
        g = a(g, h, u, f, w[i + 4], 20, 3889429448);

        f = a(f, g, h, u, w[i + 9], 5, 568446438);
        u = a(u, f, g, h, w[i + 14], 9, 3275163606);
        h = a(h, u, f, g, w[i + 3], 14, 4107603335);
        g = a(g, h, u, f, w[i + 8], 20, 1163531501);

        f = a(f, g, h, u, w[i + 13], 5, 2850285829);
        u = a(u, f, g, h, w[i + 2], 9, 4243563512);
        h = a(h, u, f, g, w[i + 7], 14, 1735328473);
        g = a(g, h, u, f, w[i + 12], 20, 2368359562);

        f = n(f, g, h, u, w[i + 5], 4, 4294588738);
        u = n(u, f, g, h, w[i + 8], 11, 2272392833);
        h = n(h, u, f, g, w[i + 11], 16, 1839030562);
        g = n(g, h, u, f, w[i + 14], 23, 4259657740);

        f = n(f, g, h, u, w[i + 1], 4, 2763975236);
        u = n(u, f, g, h, w[i + 4], 11, 1272893353);
        h = n(h, u, f, g, w[i + 7], 16, 4139469664);
        g = n(g, h, u, f, w[i + 10], 23, 3200236656);

        f = n(f, g, h, u, w[i + 13], 4, 681279174);
        u = n(u, f, g, h, w[i + 0], 11, 3936430074);
        h = n(h, u, f, g, w[i + 3], 16, 3572445317);
        g = n(g, h, u, f, w[i + 6], 23, 76029189);

        f = o(f, g, h, u, w[i + 0], 6, 4096336452);
        u = o(u, f, g, h, w[i + 7], 10, 1126891415);
        h = o(h, u, f, g, w[i + 14], 15, 2878612391);
        g = o(g, h, u, f, w[i + 5], 21, 4237533241);

        f = o(f, g, h, u, w[i + 12], 6, 1700485571);
        u = o(u, f, g, h, w[i + 3], 10, 2399980690);
        h = o(h, u, f, g, w[i + 10], 15, 4293915773);
        g = o(g, h, u, f, w[i + 1], 21, 2240044497);

        f = o(f, g, h, u, w[i + 8], 6, 1873313359);
        u = o(u, f, g, h, w[i + 15], 10, 4264355552);
        h = o(h, u, f, g, w[i + 6], 15, 2734768916);
        g = o(g, h, u, f, w[i + 13], 21, 1309151649);

        f = o(f, g, h, u, w[i + 4], 6, 4149444226);
        u = o(u, f, g, h, w[i + 11], 10, 3174756917);
        h = o(h, u, f, g, w[i + 2], 15, 718787259);
        g = o(g, h, u, f, w[i + 9], 21, 3951481745);

        f = c(f, s);
        g = c(g, p);
        h = c(h, d);
        u = c(u, m);
    }

    return (r(f) + r(g) + r(h) + r(u)).toLowerCase();
};